import { useState, useRef, useEffect } from 'react'
import type { FormEvent } from 'react'
import api from '../services/api'
import { useAuth } from '../context/AuthContext'
import { toast } from 'react-hot-toast'
import {
    Camera,
    Loader2,
    User as UserIcon,
    Crown,
    ShieldCheck,
    CreditCard,
    Check,
    AlertCircle,
    Store,
    Phone,
    Mail,
    Key,
    Zap,
    Eye,
    EyeOff
} from 'lucide-react'
import ImageCropper from '../components/ImageCropper'
import { PLANS } from '../constants/plans'
import LoadingOverlay from '../components/LoadingOverlay'
import { maskPhone } from '../utils/masks'

const calculatePasswordStrength = (password: string): { score: number, color: string, label: string } => {
    if (!password) return { score: 0, color: 'bg-slate-200', label: '' }

    let score = 0
    if (password.length > 5) score += 1
    if (password.length >= 8) score += 1
    if (/[a-z]/.test(password) && /[A-Z]/.test(password)) score += 1
    if (/[0-9]/.test(password)) score += 1
    if (/[^A-Za-z0-9]/.test(password)) score += 1

    if (score < 2) return { score: 25, color: 'bg-red-500', label: 'Fraca' }
    if (score < 4) return { score: 60, color: 'bg-amber-400', label: 'Razoável' }
    return { score: 100, color: 'bg-emerald-500', label: 'Forte' }
}

export default function ProfilePage() {
    const { user } = useAuth()
    const [activeTab, setActiveTab] = useState<'general' | 'subscription' | 'security'>('general')

    const [saving, setSaving] = useState(false)
    const [isLoadingUsage, setIsLoadingUsage] = useState(false)
    const [isSubscribing, setIsSubscribing] = useState<string | null>(null)
    const [imagePreview, setImagePreview] = useState<string | null>(null)
    const [cropImageSrc, setCropImageSrc] = useState<string | null>(null)
    const fileInputRef = useRef<HTMLInputElement>(null)

    const [usage, setUsage] = useState({
        products: { used: 0, limit: 10 },
        categories: { used: 0, limit: 2 },
        plan_id: user?.plan_id || 'free'
    })

    const [form, setForm] = useState({
        full_name: '',
        email: '',
        phone: '',
        store_name: '',
        photo_base64: '',
        password: '',
        confirm_password: ''
    })

    const [showPassword, setShowPassword] = useState(false)
    const [showConfirmPassword, setShowConfirmPassword] = useState(false)

    useEffect(() => {
        if (user) {
            setForm(prev => ({
                ...prev,
                full_name: user.full_name || '',
                email: user.email || '',
                phone: user.phone || '',
                store_name: user.store_name || '',
                photo_base64: user.photo_base64 || ''
            }))
            setImagePreview(user.photo_base64 || null)
        }
    }, [user])

    const fetchUsageData = async () => {
        setIsLoadingUsage(true)
        try {
            const res = await api.get('/plans/usage')
            setUsage(res.data)
        } catch (err) {
            console.error('Erro ao buscar uso dos planos:', err)
        } finally {
            setIsLoadingUsage(false)
        }
    }

    useEffect(() => {
        fetchUsageData()
    }, [])

    useEffect(() => {
        if (activeTab === 'subscription') {
            fetchUsageData()
        }
    }, [activeTab])

    const handleImageSelect = (e: React.ChangeEvent<HTMLInputElement>) => {
        if (e.target.files && e.target.files.length > 0) {
            const file = e.target.files[0]
            const reader = new FileReader()
            reader.onload = () => {
                setCropImageSrc(reader.result as string)
            }
            reader.readAsDataURL(file)
            e.target.value = ''
        }
    }

    const handleCropComplete = (blob: Blob) => {
        const reader = new FileReader()
        reader.onloadend = () => {
            const base64String = reader.result as string
            setForm(prev => ({ ...prev, photo_base64: base64String }))
            setImagePreview(base64String)
        }
        reader.readAsDataURL(blob)
        setCropImageSrc(null)
    }

    const handleSubmit = async (e: FormEvent) => {
        e.preventDefault()

        if (activeTab === 'security' && form.password && form.password !== form.confirm_password) {
            toast.error('As senhas não coincidem.')
            return
        }

        setSaving(true)
        try {
            const payload: any = {
                full_name: form.full_name,
                email: form.email,
                phone: form.phone || null,
                store_name: form.store_name || null,
                photo_base64: form.photo_base64 || null
            }

            if (form.password) {
                payload.password = form.password
            }

            await api.put('/auth/me', payload)
            toast.success('Perfil atualizado com sucesso!')

            setTimeout(() => {
                window.location.reload()
            }, 1000)

        } catch (err: any) {
            toast.error(err.response?.data?.detail || 'Erro ao atualizar perfil')
        } finally {
            setSaving(false)
        }
    }

    const handleSubscribe = async (planId: string) => {
        if (planId === user?.plan_id) return
        setIsSubscribing(planId)
        try {
            await api.patch('/plans/subscribe', { plan_id: planId })
            toast.success('Plano atualizado com sucesso!')
            setTimeout(() => {
                window.location.reload()
            }, 1000)
        } catch (err: any) {
            toast.error(err.response?.data?.detail || 'Erro ao atualizar assinatura')
        } finally {
            setIsSubscribing(null)
        }
    }

    const calculateProgress = (used: number, limit: number) => {
        if (limit >= 999999) return 0
        return Math.min((used / limit) * 100, 100)
    }

    const currentPlan = PLANS.find(p => p.id === (user?.plan_id || usage.plan_id)) || PLANS[0]
    const effectivePlanId = user?.plan_id === 'enterprise' ? 'pro' : (user?.plan_id || 'free');

    return (
        <div className="max-w-5xl mx-auto pb-24 px-4 sm:px-6 relative">

            {/* Subtle Brand Background Glow */}
            <div className="absolute top-0 left-1/2 -translate-x-1/2 w-4/5 h-64 bg-brand-100/40 rounded-[100%] blur-[100px] pointer-events-none -z-10" />

            <div className="pt-8 pb-8 flex flex-col sm:flex-row sm:items-end justify-between gap-6">
                <div>
                    <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight">Configurações</h1>
                    <p className="text-sm font-medium text-slate-500 mt-1">Gerencie suas preferências com facilidade</p>
                </div>

                {/* Refined Segmented Control */}
                <div className="flex bg-white/80 backdrop-blur shadow-sm border border-slate-200/60 p-1.5 rounded-2xl w-fit">
                    {(['general', 'subscription', 'security'] as const).map((tab) => (
                        <button
                            key={tab}
                            onClick={() => setActiveTab(tab)}
                            className={`flex items-center gap-2.5 px-6 py-2.5 rounded-[10px] text-sm font-semibold transition-all duration-300 ${activeTab === tab
                                ? 'bg-brand-50 text-brand-700 shadow-sm ring-1 ring-brand-100/50'
                                : 'text-slate-500 hover:text-slate-800 hover:bg-slate-50'
                                }`}
                        >
                            {tab === 'general' && <UserIcon className="w-4 h-4" />}
                            {tab === 'subscription' && <Crown className="w-4 h-4" />}
                            {tab === 'security' && <ShieldCheck className="w-4 h-4" />}
                            {tab === 'general' ? 'Geral' : tab === 'subscription' ? 'Assinatura' : 'Segurança'}
                        </button>
                    ))}
                </div>
            </div>

            <div className="glass-card rounded-[2.5rem] overflow-hidden">
                <div className="p-8 sm:p-12">
                    {activeTab === 'general' && (
                        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">

                            {/* Profile Header (Avatar + Name) */}
                            <div className="flex flex-col sm:flex-row items-center gap-8 mb-12 relative group/header">
                                <div
                                    className="relative group cursor-pointer"
                                    onClick={() => fileInputRef.current?.click()}
                                >
                                    <div className="w-32 h-32 rounded-[2rem] bg-brand-50 flex items-center justify-center overflow-hidden ring-4 ring-white shadow-xl shadow-brand-500/10 transition-transform duration-500 group-hover:scale-[1.02]">
                                        {imagePreview ? (
                                            <img src={imagePreview} alt="Avatar" className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" />
                                        ) : (
                                            <span className="text-5xl font-black text-brand-200">
                                                {user?.full_name?.charAt(0)?.toUpperCase()}
                                            </span>
                                        )}
                                    </div>
                                    <div className="absolute inset-0 bg-brand-900/40 backdrop-blur-[2px] rounded-[2rem] opacity-0 group-hover:opacity-100 transition-all duration-300 flex flex-col items-center justify-center text-white">
                                        <Camera className="w-8 h-8 mb-1 animate-bounce-slow" />
                                        <span className="text-[10px] font-bold uppercase tracking-widest">Alterar</span>
                                    </div>
                                </div>

                                <div className="text-center sm:text-left">
                                    <h2 className="text-3xl font-extrabold text-slate-800 tracking-tight">{user?.full_name}</h2>
                                    <div className="inline-flex items-center gap-1.5 px-3 py-1 bg-brand-50 text-brand-600 rounded-full text-xs font-bold mt-2">
                                        <Zap className="w-3 h-3 fill-current" />
                                        Membro Ativo
                                    </div>
                                </div>

                                <input type="file" ref={fileInputRef} onChange={handleImageSelect} accept="image/*" className="hidden" />
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-8 max-w-3xl">
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-6">
                                    <div className="sm:col-span-2 group/input">
                                        <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Nome Completo</label>
                                        <div className="relative">
                                            <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                                                <UserIcon className="h-5 w-5 text-slate-300 group-focus-within/input:text-brand-500 transition-colors" />
                                            </div>
                                            <input
                                                required
                                                value={form.full_name}
                                                onChange={(e) => setForm({ ...form, full_name: e.target.value })}
                                                className="w-full h-12 pl-12 pr-4 text-sm font-semibold bg-slate-50/50 border border-slate-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-brand-500/10 focus:border-brand-400 focus:bg-white hover:bg-slate-50 transition-all duration-300 shadow-sm"
                                            />
                                        </div>
                                    </div>

                                    <div className="sm:col-span-2 group/input">
                                        <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Nome da Loja</label>
                                        <div className="relative">
                                            <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                                                <Store className="h-5 w-5 text-slate-300 group-focus-within/input:text-brand-500 transition-colors" />
                                            </div>
                                            <input
                                                value={form.store_name}
                                                onChange={(e) => setForm({ ...form, store_name: e.target.value })}
                                                className="w-full h-12 pl-12 pr-4 text-sm font-semibold bg-slate-50/50 border border-slate-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-brand-500/10 focus:border-brand-400 focus:bg-white hover:bg-slate-50 transition-all duration-300 shadow-sm"
                                            />
                                        </div>
                                    </div>

                                    <div className="group/input">
                                        <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">E-mail</label>
                                        <div className="relative">
                                            <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                                                <Mail className="h-5 w-5 text-slate-300 group-focus-within/input:text-brand-500 transition-colors" />
                                            </div>
                                            <input
                                                required
                                                type="email"
                                                value={form.email}
                                                onChange={(e) => setForm({ ...form, email: e.target.value })}
                                                className="w-full h-12 pl-12 pr-4 text-sm font-semibold bg-slate-50/50 border border-slate-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-brand-500/10 focus:border-brand-400 focus:bg-white hover:bg-slate-50 transition-all duration-300 shadow-sm"
                                            />
                                        </div>
                                    </div>

                                    <div className="group/input">
                                        <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Telefone</label>
                                        <div className="relative">
                                            <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                                                <Phone className="h-5 w-5 text-slate-300 group-focus-within/input:text-brand-500 transition-colors" />
                                            </div>
                                            <input
                                                value={form.phone}
                                                onChange={(e) => setForm({ ...form, phone: maskPhone(e.target.value) })}
                                                className="w-full h-12 pl-12 pr-4 text-sm font-semibold bg-slate-50/50 border border-slate-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-brand-500/10 focus:border-brand-400 focus:bg-white hover:bg-slate-50 transition-all duration-300 shadow-sm"
                                                placeholder="(00) 00000-0000"
                                            />
                                        </div>
                                    </div>
                                </div>

                                <div className="pt-6 flex justify-end">
                                    <button
                                        type="submit"
                                        disabled={saving}
                                        className="h-12 px-8 font-bold bg-brand-600 text-white rounded-2xl hover:bg-brand-700 transition-all shadow-lg shadow-brand-500/30 flex items-center gap-2 active:scale-95 disabled:opacity-60"
                                    >
                                        {saving ? <Loader2 className="w-5 h-5 animate-spin" /> : null}
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {activeTab === 'subscription' && (
                        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 relative max-w-4xl mx-auto">
                            {isLoadingUsage && <LoadingOverlay message="Caregando métricas..." />}

                            <div className="flex flex-col gap-10 mb-8">
                                {/* Current Plan Status - Prominent Top Card */}
                                <div className="w-full">
                                    <div className="bg-white border border-brand-100 rounded-[2.5rem] p-8 sm:p-10 shadow-xl shadow-brand-100/50 relative overflow-hidden group/plan">
                                        <div className="absolute top-0 right-0 w-64 h-64 bg-brand-50 rounded-full blur-[80px] -mr-20 -mt-20 transition-transform duration-1000 group-hover/plan:scale-125" />

                                        <div className="relative z-10 flex flex-col md:flex-row gap-10 items-center md:items-start justify-between">
                                            <div className="flex-1 text-center md:text-left">
                                                <div className="flex flex-col sm:flex-row items-center gap-4 mb-4 justify-center md:justify-start">
                                                    <h4 className="text-4xl font-extrabold text-slate-800 tracking-tight">{currentPlan.name}</h4>
                                                    <span className="px-4 py-1.5 bg-emerald-50 text-emerald-600 border border-emerald-100/50 text-xs font-black uppercase tracking-widest rounded-full flex items-center gap-2 shadow-sm">
                                                        <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse shadow-[0_0_8px_rgba(16,185,129,0.4)]" /> Ativo
                                                    </span>
                                                </div>
                                                <p className="text-slate-500 text-base font-medium max-w-sm mx-auto md:mx-0 leading-relaxed">{currentPlan.description}</p>
                                            </div>

                                            {/* Progress Meters */}
                                            <div className="w-full md:w-[28rem] flex-shrink-0 space-y-7 bg-slate-50/50 p-6 sm:p-8 rounded-[2rem] border border-slate-100 shadow-inner">
                                                <div className="group/progress">
                                                    <div className="flex justify-between items-end mb-3">
                                                        <span className="text-sm font-black text-slate-400 uppercase tracking-widest">Produtos</span>
                                                        <span className="text-base font-black text-brand-600"><span className="text-slate-800 text-2xl">{usage.products.used}</span> <span className="text-slate-300 mx-1">/</span> {usage.products.limit >= 999999 ? '∞' : usage.products.limit}</span>
                                                    </div>
                                                    <div className="h-3 w-full bg-slate-200/60 rounded-full overflow-hidden p-[3px] shadow-inner">
                                                        <div
                                                            className="h-full bg-gradient-to-r from-brand-400 to-brand-600 rounded-full transition-all duration-1000 shadow-sm relative overflow-hidden"
                                                            style={{ width: `${calculateProgress(usage.products.used, usage.products.limit)}%` }}
                                                        >
                                                            <div className="absolute inset-0 bg-white/20 w-full animate-[shimmer_2s_infinite]" style={{ backgroundImage: 'linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent)' }} />
                                                        </div>
                                                    </div>
                                                </div>

                                                <div className="group/progress">
                                                    <div className="flex justify-between items-end mb-3">
                                                        <span className="text-sm font-black text-slate-400 uppercase tracking-widest">Categorias</span>
                                                        <span className="text-base font-black text-brand-600"><span className="text-slate-800 text-2xl">{usage.categories.used}</span> <span className="text-slate-300 mx-1">/</span> {usage.categories.limit >= 999999 ? '∞' : usage.categories.limit}</span>
                                                    </div>
                                                    <div className="h-3 w-full bg-slate-200/60 rounded-full overflow-hidden p-[3px] shadow-inner">
                                                        <div
                                                            className="h-full bg-gradient-to-r from-brand-400 to-brand-600 rounded-full transition-all duration-1000 shadow-sm relative overflow-hidden"
                                                            style={{ width: `${calculateProgress(usage.categories.used, usage.categories.limit)}%` }}
                                                        >
                                                            <div className="absolute inset-0 bg-white/20 w-full animate-[shimmer_2s_infinite]" style={{ backgroundImage: 'linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent)' }} />
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* Upgrades List */}
                                <div className="w-full mt-4">
                                    <div className="mb-8 text-center md:text-left pl-2">
                                        <h3 className="text-2xl font-extrabold text-slate-800 tracking-tight">Evolua seu plano</h3>
                                        <p className="text-slate-500 font-medium mt-1 text-sm">Escolha a melhor opção para o tamanho do seu negócio.</p>
                                    </div>

                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 auto-rows-fr">
                                        {PLANS.filter(p => !p.hidden).map((p) => {
                                            const isSelected = p.id === effectivePlanId
                                            const isPopular = p.highlight

                                            // Flex column layout inside the card ensures the button is always at the bottom
                                            return (
                                                <div
                                                    key={p.id}
                                                    className={`group p-8 rounded-[2.5rem] border transition-all duration-300 flex flex-col h-full relative overflow-hidden ${isSelected
                                                        ? 'border-brand-300 bg-brand-50 shadow-xl shadow-brand-200/50 ring-2 ring-brand-100'
                                                        : 'border-slate-200/80 bg-white hover:border-brand-300 hover:shadow-2xl hover:shadow-slate-200/50 hover:-translate-y-2'
                                                        }`}
                                                >
                                                    {isPopular && !isSelected && (
                                                        <div className="absolute -top-4 -right-4 w-24 h-24 bg-brand-100 rounded-full blur-2xl opacity-50 transition-transform duration-500 group-hover:scale-150" />
                                                    )}

                                                    <div className="flex flex-col items-center sm:items-start lg:items-center xl:items-start gap-5 mb-8 text-center sm:text-left lg:text-center xl:text-left">
                                                        <div className={`w-16 h-16 rounded-[1.5rem] flex items-center justify-center shrink-0 transition-all ${isSelected ? 'bg-brand-600 text-white shadow-xl shadow-brand-500/30' : 'bg-slate-100 text-slate-500 group-hover:bg-brand-100 group-hover:text-brand-600 group-hover:shadow-lg'
                                                            }`}>
                                                            <CreditCard className="w-7 h-7" />
                                                        </div>
                                                        <div className="mt-2 sm:mt-0">
                                                            <h4 className="font-extrabold text-slate-800 text-2xl tracking-tight leading-none mb-3">{p.name}</h4>
                                                            {isPopular && <span className="inline-block text-[10px] font-black bg-brand-600 text-white px-3 py-1.5 rounded-lg uppercase tracking-widest shadow-sm ring-4 ring-brand-100/50">Mais Popular</span>}
                                                        </div>
                                                    </div>

                                                    <div className="mb-10 flex-grow">
                                                        <ul className="space-y-4">
                                                            {p.features.slice(0, 3).map((feat, i) => (
                                                                <li key={i} className="flex items-start gap-3 text-[14px] font-semibold text-slate-600 justify-center sm:justify-start lg:justify-center xl:justify-start">
                                                                    <Check className={`w-5 h-5 shrink-0 mt-0 ${isSelected ? 'text-brand-600' : 'text-slate-300 group-hover:text-brand-500'}`} />
                                                                    <span className="leading-relaxed text-left">{feat}</span>
                                                                </li>
                                                            ))}
                                                        </ul>
                                                    </div>

                                                    <div className="border-t border-slate-100/80 pt-8 mt-auto">
                                                        <div className="flex items-baseline justify-center sm:justify-start lg:justify-center xl:justify-start gap-2 mb-6">
                                                            <p className="font-black text-slate-800 text-4xl tracking-tighter">{p.price}</p>
                                                            <p className="text-[11px] font-black text-slate-400 uppercase tracking-widest">/ mês</p>
                                                        </div>
                                                        <button
                                                            onClick={() => !isSelected && handleSubscribe(p.id)}
                                                            disabled={isSelected || isSubscribing === p.id}
                                                            className={`w-full h-14 rounded-[1.25rem] text-[15px] font-black transition-all flex items-center justify-center gap-2 ${isSelected
                                                                ? 'bg-brand-600 text-white shadow-xl shadow-brand-500/30 cursor-default ring-4 ring-brand-100'
                                                                : 'bg-slate-100 text-slate-700 hover:bg-brand-600 hover:text-white shadow-sm hover:shadow-brand-500/20 hover:scale-[1.02]'
                                                                }`}
                                                        >
                                                            {isSubscribing === p.id
                                                                ? <Loader2 className="w-5 h-5 animate-spin" />
                                                                : isSelected ? 'Plano Atual' : 'Assinar Plano'}
                                                        </button>
                                                    </div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                    <div className="mt-10 flex flex-col sm:flex-row items-center sm:items-start gap-5 p-6 bg-brand-50 border border-brand-100/50 rounded-[2rem] text-sm font-medium text-brand-800 shadow-sm max-w-3xl mx-auto text-center sm:text-left transition-all hover:bg-white hover:shadow-md">
                                        <div className="w-12 h-12 rounded-full bg-white flex items-center justify-center shrink-0 shadow-sm">
                                            <AlertCircle className="w-6 h-6 text-brand-500" />
                                        </div>
                                        <p className="leading-relaxed mt-1">Nossos planos são flexíveis. Você pode alterar seu plano a qualquer momento sem burocracia, e o ajuste no valor ocorre automaticamente na próxima fatura.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'security' && (
                        <div className="animate-in fade-in slide-in-from-bottom-4 duration-500 relative">

                            <div className="mb-10 max-w-2xl">
                                <h3 className="text-2xl font-extrabold text-slate-800 tracking-tight">Segurança da Conta</h3>
                                <p className="text-sm font-medium text-slate-500 mt-1">Atualize sua senha para manter o acesso restrito e protegido.</p>
                            </div>

                            <form onSubmit={handleSubmit} className="space-y-6 max-w-xl">
                                <div className="p-6 bg-amber-50 rounded-3xl border border-amber-200/60 mb-8 flex items-start gap-4">
                                    <ShieldCheck className="w-6 h-6 text-amber-500 shrink-0" />
                                    <div>
                                        <p className="text-sm font-bold text-amber-900 mb-1">Dica de Segurança</p>
                                        <p className="text-xs font-medium text-amber-700/80 leading-relaxed">
                                            Recomendamos usar uma combinação de letras maiúsculas, minúsculas, números e símbolos para criar uma senha forte e inquebrável.
                                        </p>
                                    </div>
                                </div>

                                <div className="space-y-5">
                                    <div className="group/input">
                                        <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Nova Senha</label>
                                        <div className="relative">
                                            <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                                                <Key className="h-5 w-5 text-slate-300 group-focus-within/input:text-brand-500 transition-colors" />
                                            </div>
                                            <input
                                                type={showPassword ? 'text' : 'password'}
                                                value={form.password}
                                                onChange={(e) => setForm({ ...form, password: e.target.value })}
                                                className="w-full h-12 pl-12 pr-12 text-sm font-semibold bg-slate-50/50 border border-slate-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-brand-500/10 focus:border-brand-400 focus:bg-white hover:bg-slate-50 transition-all duration-300 shadow-sm"
                                                placeholder="••••••••"
                                            />
                                            <button
                                                type="button"
                                                onClick={() => setShowPassword(!showPassword)}
                                                className="absolute inset-y-0 right-4 flex items-center text-slate-400 hover:text-slate-600 focus:outline-none transition-colors"
                                            >
                                                {showPassword ? <EyeOff className="h-5 w-5" /> : <Eye className="h-5 w-5" />}
                                            </button>
                                        </div>
                                        {/* Password Strength Indicator */}
                                        {form.password && (
                                            <div className="mt-3 px-1 animate-in fade-in zoom-in-95 duration-300">
                                                <div className="flex justify-between items-center mb-1.5">
                                                    <span className="text-[10px] font-black uppercase tracking-widest text-slate-500">Força da Senha</span>
                                                    <span className={`text-[10px] font-black uppercase tracking-widest ${calculatePasswordStrength(form.password).color.replace('bg-', 'text-')}`}>
                                                        {calculatePasswordStrength(form.password).label}
                                                    </span>
                                                </div>
                                                <div className="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden flex gap-0.5">
                                                    <div
                                                        className={`h-full rounded-full transition-all duration-500 ${calculatePasswordStrength(form.password).color}`}
                                                        style={{ width: `${calculatePasswordStrength(form.password).score}%` }}
                                                    />
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    <div className="group/input">
                                        <label className="text-[11px] font-bold text-slate-400 uppercase tracking-wider mb-2 block ml-1">Confirme a Nova Senha</label>
                                        <div className="relative">
                                            <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                                                <Key className="h-5 w-5 text-slate-300 group-focus-within/input:text-brand-500 transition-colors" />
                                            </div>
                                            <input
                                                type={showConfirmPassword ? 'text' : 'password'}
                                                value={form.confirm_password}
                                                onChange={(e) => setForm({ ...form, confirm_password: e.target.value })}
                                                className="w-full h-12 pl-12 pr-12 text-sm font-semibold bg-slate-50/50 border border-slate-200 rounded-2xl focus:outline-none focus:ring-4 focus:ring-brand-500/10 focus:border-brand-400 focus:bg-white hover:bg-slate-50 transition-all duration-300 shadow-sm"
                                                placeholder="••••••••"
                                            />
                                            <button
                                                type="button"
                                                onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                                                className="absolute inset-y-0 right-4 flex items-center text-slate-400 hover:text-slate-600 focus:outline-none transition-colors"
                                            >
                                                {showConfirmPassword ? <EyeOff className="h-5 w-5" /> : <Eye className="h-5 w-5" />}
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div className="pt-8 flex justify-start">
                                    <button
                                        type="submit"
                                        disabled={saving || !form.password}
                                        className="h-12 px-8 font-bold bg-slate-800 text-white rounded-2xl hover:bg-slate-900 transition-all shadow-lg shadow-slate-300 flex items-center gap-2 active:scale-95 disabled:opacity-60"
                                    >
                                        {saving ? <Loader2 className="w-5 h-5 animate-spin" /> : <ShieldCheck className="w-5 h-5" />}
                                        Atualizar Senha
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}
                </div>
            </div>

            {cropImageSrc && (
                <ImageCropper
                    imageSrc={cropImageSrc}
                    onCropComplete={handleCropComplete}
                    onCancel={() => setCropImageSrc(null)}
                />
            )}
        </div>
    )
}
